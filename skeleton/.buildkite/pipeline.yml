# The Buildkite pipeline definition.
# See https://buildkite.com/docs/pipelines for documentation.

# The "cd skeleton" commands are here because this is in a subdirectory of
# iohk-nix.
# TODO: remove all the "cd skeleton" lines

steps:
  - label: Check Hydra evaluation of release.nix
    commands:
      - ".buildkite/set-skeleton-pin.sh && cd skeleton"  # TODO: remove this line
      - "nix-build -A iohkLib.check-hydra -o check-hydra.sh"
      # TODO: uncomment the following line
      # - "./check-hydra.sh"
    agents:
      system: x86_64-linux

  # This will ensure that the generated Nix code is kept up to date.
  - label: Check auto-generated Nix
    commands:
      - ".buildkite/set-skeleton-pin.sh && cd skeleton"  # TODO: remove this line
      - "nix-build -A iohkLib.check-nix-tools -o check-nix-tools.sh"
      - "git checkout -- nix/iohk-nix-src.json"  # TODO: remove this line
      - "./check-nix-tools.sh"
    agents:
      system: x86_64-linux

  # TODO: Remove this and define your own build steps.
  - label: Lint the fuzz
    commands:
      - ".buildkite/set-skeleton-pin.sh && cd skeleton"  # TODO: remove this line
      - "nix-build -A checks.lint-fuzz -o check-lint-fuzz.sh"
      - "./check-lint-fuzz.sh"
    agents:
      system: x86_64-linux

  # Imperative build steps
  - label: Stack build
    commands:
      - ".buildkite/set-skeleton-pin.sh && cd skeleton"  # TODO: remove this line
      - "nix-build .buildkite/default.nix -o stack-rebuild"
      - "./stack-rebuild"
    agents:
      system: x86_64-linux
    timeout_in_minutes: 60
